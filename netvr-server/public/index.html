<!DOCTYPE html>
<html>
  <head>
    <style>
      .event {
        border: 1px solid gray;
        margin: 8px;
        padding: 8px;
      }
      pre {
        margin-bottom: 2px;
      }
      #events {
        max-width: 600px;
      }
      .device {
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div>Hello world!</div>
    <div id="events"></div>
    <script type="module">
      import { promisifyWebsocket } from "/utils.js";
      const events = document.querySelector("#events");

      try {
        const socket = await promisifyWebsocket(createSocket());
        send(socket, { action: "gimme id" });
        for await (const message of socket) {
          const div = document.createElement("div");
          events.appendChild(div);
          clear();
          div.className = "event";
          div.innerHTML = `
          <div>ðŸ”½ ${new Date().toISOString()}</div>
          ${
            typeof message.data === "string"
              ? "<pre>" +
                JSON.stringify(JSON.parse(message.data), null, 2) +
                "</pre>"
              : stringify(message.data)
          }
          `;
        }
      } finally {
        setTimeout(() => {
          location.reload();
        }, 1000);
      }

      function send(socket, data) {
        const div = document.createElement("div");
        events.appendChild(div);
        clear();
        div.className = "event";
        div.innerHTML = `
        <div>ðŸ”¼ ${new Date().toISOString()}</div>
        <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
        socket.send(JSON.stringify(data));
      }

      function clear() {
        while (events.childElementCount > 10) {
          events.removeChild(events.children[0]);
        }
      }

      function stringify(/** @type {ArrayBuffer}*/ data) {
        let view = new DataView(data, 0, data.byteLength);
        const length = view.getInt32(0, true);
        let res = "<div>";
        for (let i = 0; i < length; ++i) {
          view = new DataView(data, 4 + 79 * i, 79);
          res += `#${view.getInt32(0, true)}`;
          res += getTypePosRot(view, 4);
          res += getTypePosRot(view, 29);
          res += getTypePosRot(view, 54);
        }
        res += "</div>";
        return res;
      }

      function getTypePosRot(view, offset) {
        return `<div class="device">
          type: ${view.getUint8(offset)}
          position: ${getVector3(view, offset + 1)}
          rotation: ${getVector3(view, offset + 13)}</div>`;
      }

      function getVector3(view, offset) {
        const fixed = 3;
        return `${view.getFloat32(offset, true).toFixed(fixed)}, ${view
          .getFloat32(offset + 4, true)
          .toFixed(fixed)}, ${view
          .getFloat32(offset + 8, true)
          .toFixed(fixed)}`;
      }

      function createSocket() {
        const socketUrl = new URL(import.meta.url);
        socketUrl.pathname = "/ws";
        socketUrl.protocol = socketUrl.protocol === "https:" ? "wss:" : "ws:";
        const socket = new WebSocket(socketUrl.toString());
        socket.binaryType = "arraybuffer";
        return socket;
      }
    </script>
  </body>
</html>
